<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Draw Something</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/underscore.js"></script>
    <script src="js/vendor/kinetic-v4.0.4.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
<script type="text/template" id="Js_header_tpl">
<h1>Draw Something</h1>
<h2>Hello: <%= name %></h2>
</script>
<header id="Js_header"></header>
<div id="Js_canvas" class="canvas"></div>
<div class="tools">
    <table id="Js_palette" class="palette">
        <tbody>
        <tr>
            <td data-color="#000" style="background-color: #000"></td>
            <td data-color="#008" style="background-color: #008"></td>
            <td data-color="#00f" style="background-color: #00f"></td>
            <td data-color="#080" style="background-color: #080"></td>
            <td data-color="#088" style="background-color: #088"></td>
            <td data-color="#0f0" style="background-color: #0f0"></td>
            <td data-color="#0f8" style="background-color: #0f8"></td>
            <td data-color="#0ff" style="background-color: #0ff"></td>
        </tr>
        <tr>
            <td data-color="#f00" style="background-color: #f00"></td>
            <td data-color="#f08" style="background-color: #f08"></td>
            <td data-color="#f0f" style="background-color: #f0f"></td>
            <td data-color="#f80" style="background-color: #f80"></td>
            <td data-color="#f88" style="background-color: #f88"></td>
            <td data-color="#ff0" style="background-color: #ff0"></td>
            <td data-color="#ff8" style="background-color: #ff8"></td>
            <td data-color="#fff" style="background-color: #fff"></td>
        </tr>
        </tbody>
    </table>
    <ul id="Js_shape" class="shape">
        <li><a data-shape="line">Line</a></li>
        <li><a data-shape="rect">Rect</a></li>
        <li><a data-shape="circle">Circle</a></li>
    </ul>
    <label for="Js_strokeWidth">画笔粗细<input type="range" id="Js_strokeWidth" min="1" max="100" value="1"></label>
</div>
<script>
//页面模版处理
var userInfo = {};
//userInfo.name = prompt("你妈贵姓");
Draw.render("Js_header", userInfo);
</script>
<script>
    var stage = new Kinetic.Stage({
        container: "Js_canvas",
        width: 960,
        height: 400
    });
    var layer = new Kinetic.Layer();

    var background = new Kinetic.Rect({
        x: 0,
        y: 0,
        width: stage.getWidth(),
        height: stage.getHeight(),
        fill: "white"
    });

    layer.add(background);
    stage.add(layer);

    var moving = false;
    var pos = [];
    var color = "#000";
    var shape = "line";
    var width = 1;
    var line;
    var rect;
    var circle;

    document.getElementById("Js_palette").addEventListener("click", function(evt){
        if(evt.target.dataset.color) {
            color = evt.target.dataset.color;
        }
    }, false);
    document.getElementById("Js_shape").addEventListener("click", function(evt){
        if(evt.target.dataset.shape) {
            shape = evt.target.dataset.shape;
        }
    }, false);
    document.getElementById("Js_strokeWidth").addEventListener("change", function(evt){
        width = this.value;
    }, false);
    stage.on("mousedown", function(){
        if (moving){
            moving = false;
            layer.draw();
        } else {
            var mousePos = stage.getMousePosition();
            switch(shape) {
                case "line":
                default :
                    line = new Kinetic.Line({
                        points: [mousePos.x, mousePos.y, mousePos.x, mousePos.y],
                        stroke: color,
                        strokeWidth: width
                    });
                    layer.add(line);
                    moving = true;
                    //layer.drawScene();
                    break;
                case "rect":
                    rect = new Kinetic.Rect({
                        x: mousePos.x,
                        y: mousePos.y,
                        stroke: color,
                        strokeWidth: width
                    });
                    pos.push(mousePos.x);
                    pos.push(mousePos.y);
                    layer.add(rect);
                    moving = true;
                    break;
                case "circle":
                    circle = new Kinetic.Circle({
                        x: mousePos.x,
                        y: mousePos.y,
                        stroke: color,
                        strokeWidth: width
                    });
                    pos.push(mousePos.x);
                    pos.push(mousePos.y);
                    layer.add(circle);
                    moving = true;
                    break;
            }
        }
    });

    stage.on("mousemove", function(){
        if (moving) {
            var mousePos = stage.getMousePosition();
            switch(shape) {
                case "line":
                default :
                    pos.push(mousePos.x);
                    pos.push(mousePos.y);
                    line.setPoints(pos);
                    break;
                case "rect":
                    rect.setSize([mousePos.x - pos[0], mousePos.y - pos[1]]);
                    break;
                case "circle":
                    var radius = Math.sqrt(Math.pow(mousePos.x - pos[0], 2) + Math.pow(mousePos.y - pos[1], 2));
                    circle.setRadius(radius);
                    break;
            }
            layer.drawScene();
            moving = true;
        }
    });

    stage.on("mouseup", function(){
        moving = false;
        pos = [];
    });
</script>
</body>
</html>